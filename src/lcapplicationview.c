/* lcapplicationview.c generated by valac 0.22.1, the Vala compiler
 * generated from lcapplicationview.vala, do not modify */


#include <gtk/gtk.h>
#include "lcapplicationview.h"
#include "lcapplicationrow.h"
#include "lcprotocol.h"
#include <time.h>

#define _g_list_free0(var) ((var == NULL) ? NULL : (var = (g_list_free (var), NULL)))
#define _g_object_unref0(var) ((var == NULL) ? NULL : (var = (g_object_unref (var), NULL)))

struct _LcApplicationViewPrivate {
    GtkGrid *grid;
    gint row_count;

    gboolean loading;

    guint64 update_time;
};
#define lc_application_view_get_priv(self)	((self)->priv)
#define lc_application_view_get_grid(self) \
	lc_application_view_get_priv(self)->grid
#define lc_application_view_get_row_count(self) \
	lc_application_view_get_priv(self)->row_count
#define lc_application_view_set_row_count(self,count) \
	lc_application_view_get_row_count(self)=(count)
#define lc_application_view_inc_row_count(self) \
	lc_application_view_get_row_count(self)= \
	lc_application_view_get_row_count(self) + 1
#define lc_application_view_dec_row_count(self) \
	lc_application_view_get_row_count(self) = \
	lc_application_view_get_row_count(self) - 1
#define lc_application_view_get_loading(self) \
        lc_application_view_get_priv(self)->loading
#define lc_application_view_get_updatetime(self) \
        lc_application_view_get_priv(self)->update_time
#define lc_application_view_set_updatetime(self,time) \
        lc_application_view_get_updatetime(self)=time


static gpointer lc_application_view_parent_class = NULL;

#define LC_APPLICATION_VIEW_GET_PRIVATE(o) (G_TYPE_INSTANCE_GET_PRIVATE ((o), TYPE_LC_APPLICATION_VIEW, LcApplicationViewPrivate))
enum {
    LC_APPLICATION_VIEW_DUMMY_PROPERTY
};
static void lc_application_view_finalize(GObject * obj);


LcApplicationView *lc_application_view_construct(GType object_type)
{
    LcApplicationView *self = NULL;
    self = (LcApplicationView *) g_object_new(object_type, NULL);
    gtk_container_add(GTK_CONTAINER(self),
                      (GtkWidget *) lc_application_view_get_grid(self));
    return self;
}


LcApplicationView *lc_application_view_new(void)
{
    return lc_application_view_construct(TYPE_LC_APPLICATION_VIEW);
}


static void lc_application_view_class_init(LcApplicationViewClass * klass)
{
    lc_application_view_parent_class = g_type_class_peek_parent(klass);
    g_type_class_add_private(klass, sizeof(LcApplicationViewPrivate));
    G_OBJECT_CLASS(klass)->finalize = lc_application_view_finalize;
}


static void lc_application_view_instance_init(LcApplicationView * self)
{
    self->priv = LC_APPLICATION_VIEW_GET_PRIVATE(self);

    LcApplicationViewPrivate *priv = self->priv;
    priv->grid = (GtkGrid *) gtk_grid_new();
    gtk_grid_set_column_homogeneous(priv->grid, TRUE);
    g_object_ref_sink(priv->grid);
    priv->row_count = 0;
    priv->loading = FALSE;
    priv->update_time = 0;
}


static void lc_application_view_finalize(GObject * obj)
{
    LcApplicationView *self;
    self =
        G_TYPE_CHECK_INSTANCE_CAST(obj, TYPE_LC_APPLICATION_VIEW,
                                   LcApplicationView);
    _g_object_unref0(self->priv->grid);
    G_OBJECT_CLASS(lc_application_view_parent_class)->finalize(obj);
}


GType lc_application_view_get_type(void)
{
    static volatile gsize lc_application_view_type_id__volatile = 0;
    if (g_once_init_enter(&lc_application_view_type_id__volatile)) {
        static const GTypeInfo g_define_type_info =
            { sizeof(LcApplicationViewClass), (GBaseInitFunc) NULL,
            (GBaseFinalizeFunc) NULL,
                (GClassInitFunc) lc_application_view_class_init,
            (GClassFinalizeFunc) NULL, NULL, sizeof(LcApplicationView), 0,
            (GInstanceInitFunc) lc_application_view_instance_init, NULL
        };
        GType lc_application_view_type_id;
        lc_application_view_type_id =
            g_type_register_static(GTK_TYPE_SCROLLED_WINDOW,
                                   "LcApplicationView",
                                   &g_define_type_info, 0);
        g_once_init_leave(&lc_application_view_type_id__volatile,
                          lc_application_view_type_id);
    }
    return lc_application_view_type_id__volatile;
}

static gboolean on_row_button_pressed(GtkWidget * widget,
                                      GdkEventButton * event,
                                      gpointer user_data)
{
    /* TODO */
}

void lc_application_view_append_row(LcApplicationView * self,
                                    LcProtocolApplication * info)
{
    LcApplicationRow *row = lc_application_row_new_with_data(info);
    gtk_grid_attach(lc_application_view_get_grid(self),
                    GTK_WIDGET(row),
                    0, lc_application_view_get_row_count(self), 1, 1);
    lc_application_view_inc_row_count(self);
}

void lc_application_view_remove_row(LcApplicationView * self, gint row)
{
    GtkGrid *grid = lc_application_view_get_grid(self);
    if (gtk_grid_get_child_at(grid, 0, row)) {
        gtk_grid_remove_row(grid, row);
        lc_application_view_dec_row_count(self);
    }
}

void lc_application_view_update(LcApplicationView * self, GList * list)
{
    lc_application_view_set_updatetime(self, (guint64) time(NULL));

    GList *copy = g_list_copy(list);
    gint i, max = lc_application_view_get_row_count(self);
    GtkGrid *grid = lc_application_view_get_grid(self);
    for (i = 0; i < max; i++) {
        LcApplicationRow *row =
            (LcApplicationRow *) gtk_grid_get_child_at(grid, 0, i);
        if (row) {
            LcProtocolApplication *info = lc_application_row_get_data(row);
            LcProtocolApplication *find =
                lc_protocol_application_find(list, info->package_name);
            if (find) {
                /* update */
                lc_application_row_update_data(row, find);
                copy = g_list_remove(copy, info);
            } else {
                /* not found, remove */
                lc_application_view_remove_row(self, i);
                i--;
            }
        } else {
            g_warning("WTF!! i= %d", i);
        }
    }

    GList *lp = copy;
    while (lp) {
        LcProtocolApplication *info = (LcProtocolApplication *) lp->data;
        lc_application_view_append_row(self, info);
        lp = g_list_next(lp);
    }

    g_list_free(copy);
}

void lc_application_view_set_loading(LcApplicationView * self,
                                     gboolean loading)
{
    lc_application_view_get_loading(self) = loading;
}

gboolean lc_application_view_is_loading(LcApplicationView * self)
{
    return lc_application_view_get_loading(self);
}

guint64 lc_application_view_get_update_time(LcApplicationView * self)
{
    return lc_application_view_get_updatetime(self);
}
